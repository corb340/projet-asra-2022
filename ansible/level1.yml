---

#configuration des instances Backend
- name : Configuring back-end instances
  hosts: backends
  gather_facts: yes
  vars:
    test: "Mon user eductive25: le meilleur !"
  tasks:
#installation et configuration de nginx
    - name: Ensure Nginx package is installed
      apt:
        name: nginx
        state: latest
    - name: Configure kitten page
      template:
        src: template/index.html.j2
        dest: /var/www/html/index/html
    - name: Configure Nginx to listen on the vRack
      template:
        src: template/default.j2
        dest: /etc/nginx/sites-available/default
      notify:
        - Restart nginx
#installation/configuration de docker et de ses dependances
    - name: Ensure Docker dependencies are installed
      apt:
        name:
          - apt-transport-https
          - ca-certificates
          - lsb-release
          - gnupg
        state: latest
    - name: Ensure key is succesfully installed
      apt_key:
        url: "https://download.docker.com/linux/debian/gpg"
    - name: Ensure repository is successfully updated
      apt_repository:
        repo: "deb https://download.docker.com/linux/debian bullseye stable"
    - name: Ensure successful installation of Docker
      apt:
        name:
          - docker
          - docker-compose
          - docker-compose-plugin
#installation du firewall
    - name: Ensure firewall is installed
      apt:
        name: ufw
        state: latest
#handlers des differentes composantes installees
  handlers:
    - name: Restart Nginx
      service:
        name: nginx
        state: restarted

#configuration de l'instance Front-End
- name: Install and configure HaProxy on Front-End
  hosts: front
  tasks:
#installation et configuration de HaProxy
  - name: Ensure installation and update of HaProxy
    apt:
      name: haproxy
      state: latest
  - name: Ensure HaProxy has started
    service:
      name: haproxy
      state: started
  - name: Configurate HaProxy
    template:
      src: templates/haproxy.cfg.j2
      dest: /etc/haproxy/haproxy.cfg
    notify:
    - Reload haproxy
#handlers des composantes installees
  handlers:
  - name: Reload haproxy
    service:
      name: haproxy
      state: reloaded
  - name: Reload Nginx
    service:
      name: nginx
      state: reloaded
  - name: Reload ufw (Firewall)
    service:
      name: ufw
      state: reloaded
